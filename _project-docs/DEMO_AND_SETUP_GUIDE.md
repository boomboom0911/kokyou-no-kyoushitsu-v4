# 公共の教室 v4 - デモ版 & セットアップガイド

このドキュメントは、以下の3つの目的で使用できます:
1. **デモ版の利用方法を理解する**
2. **AIアシスタント（ChatGPT/Claude等）にこのドキュメントを貼り付けて、導入サポートを受ける**
3. **自分の学校に導入する際のステップバイステップガイドとして使用する**

---

## 📋 目次

- [システム概要](#システム概要)
- [デモ版の利用方法](#デモ版の利用方法)
- [自分の学校への導入手順](#自分の学校への導入手順)
- [AIサポートの活用方法](#aiサポートの活用方法)
- [技術スタック](#技術スタック)
- [トラブルシューティング](#トラブルシューティング)

---

## システム概要

**公共の教室 v4** は、学校の授業で使える対話型学習プラットフォームです。

### 主な機能

#### 1. 授業セッション（教室）
- **リアルタイム授業参加**: 生徒が4桁のセッションコードで授業に参加
- **トピック投稿・議論**: 生徒が授業中にトピックを投稿し、クラス全体でコメント・議論
- **みんなの議論**: 全クラス・全授業のトピックを閲覧できる公共広場
- **学習メモ**: 生徒が個人的なメモを記録
- **マイポートフォリオ**: 学習履歴をJSON/CSVでエクスポート

#### 2. 掲示板システム（課題提出・ピアレビュー）
- **課題提出**: 教員が掲示板（課題）を作成し、生徒が作品を提出
- **匿名ピアレビュー**: 動物アイコンで匿名性を保ちながらレビュー（個体識別可能）
- **4軸評価**: 良い点・改善点・質問・総合コメント
- **返信機能**: 投稿者がレビューに返信可能
- **統計ダッシュボード**: 提出状況・レビュー状況を可視化
- **一括エクスポート**: 全データをCSV形式で出力

#### 3. 統合通知システム
- **リアルタイム通知**: レビュー受信・返信受信・トピックコメントを通知
- **通知ドロップダウン**: 生徒メニューに未読バッジとドロップダウン表示
- **自動更新**: 10秒ごとに未読通知数を更新

### 技術スタック

- **フロントエンド**: Next.js 15 (App Router) + TypeScript + Tailwind CSS
- **バックエンド**: Next.js API Routes
- **データベース**: Supabase (PostgreSQL)
- **認証**: localStorage ベース（デモ版）/ Google OAuth（本番用）
- **デプロイ**: Vercel
- **開発ツール**: Turbopack

---

## デモ版の利用方法

### デモ版URL
```
https://kokyou-no-kyoushitsu-v4.vercel.app
```

### 教員用ログイン

**ログインページ**: `/teacher`

デモ用教員アカウント:
```
メールアドレス: teacher@school.ed.jp
パスワード: demo1234
```

**教員でできること:**
1. 新しい授業セッションを作成（4桁コード自動生成）
2. セッション管理（トピック閲覧・コメント投稿・終了）
3. 掲示板（課題）の作成・管理
4. 提出作品の閲覧・統計確認
5. データの一括エクスポート

### 生徒用ログイン

**ログインページ**: `/student`

デモ用生徒アカウント（以下のいずれかを使用）:

| メールアドレス | 表示名 | 出席番号 | クラス |
|---|---|---|---|
| student1@school.ed.jp | 生徒1 | 1 | A組 |
| student2@school.ed.jp | 生徒2 | 2 | A組 |
| 2101@nansho.ed.jp | テスト太郎 | 2101 | 1年1組 |
| 2102@nansho.ed.jp | テスト花子 | 2102 | 1年1組 |

**パスワード**: すべて `demo1234`

**生徒でできること:**
1. **授業に参加**: セッションコードを入力して参加
2. **トピック投稿**: 授業中に議論トピックを投稿
3. **コメント**: 他の生徒のトピックにコメント
4. **みんなの議論**: 全授業のトピックを閲覧・コメント
5. **学習メモ**: 個人メモを記録
6. **マイポートフォリオ**: 投稿履歴をエクスポート
7. **掲示板（課題提出）**: 作品提出・他の生徒の作品にレビュー・レビューへの返信
8. **通知確認**: 新しいレビュー・返信・コメントを通知で確認

### デモ版の動作確認手順

#### 1. 授業セッションのテスト

1. 教員アカウントでログイン (`teacher@school.ed.jp`)
2. 「新しい授業を作成」で授業セッションを作成（例: トピック「SDGsについて考える」）
3. 生成された4桁コードをメモ（例: `AB12`）
4. 別のブラウザ or シークレットモードで生徒としてログイン
5. 「授業に参加」からセッションコードを入力
6. トピックを投稿・コメントしてみる
7. 教員画面で生徒の投稿を確認

#### 2. 掲示板（ピアレビュー）のテスト

1. 教員アカウントで「掲示板管理」→「新しい掲示板を作成」
2. 課題を作成（例: タイトル「私の夢」、説明「将来の夢について書こう」）
3. 生成された掲示板コードをメモ（例: `DREAM01`）
4. 生徒アカウントでログイン → 生徒メニュー →「掲示板」
5. 掲示板コードで検索 → 作品を提出
6. 別の生徒アカウントで同じ掲示板にアクセス → 他の生徒の作品にレビュー投稿
7. 元の生徒アカウントで通知を確認 → レビューを閲覧 → 返信を投稿
8. レビューした生徒アカウントで返信通知を確認

#### 3. 通知システムのテスト

1. 生徒Aでトピック投稿
2. 生徒Bで同じトピックにコメント
3. 生徒Aのメニュー画面で通知バッジ（🔔）に未読数が表示されることを確認
4. 通知をクリックして該当トピックに遷移
5. 通知が既読になることを確認

---

## 自分の学校への導入手順

このセクションは、SupabaseやVercelを使ったことがない方でも、AIアシスタント（ChatGPT/Claude等）のサポートを受けながら導入できるように設計されています。

### 前提条件

- Googleアカウント（学校ドメインのアカウント推奨）
- GitHubアカウント（無料）
- 基本的なコンピュータ操作ができること

### ステップ1: リポジトリをフォーク

1. GitHubにログイン
2. https://github.com/boomboom0911/kokyou-no-kyoushitsu-v4 にアクセス
3. 右上の「Fork」ボタンをクリック
4. 自分のGitHubアカウントにリポジトリがコピーされる

### ステップ2: Supabaseプロジェクトの作成

1. https://supabase.com/ にアクセス
2. 「Start your project」をクリックしてアカウント作成（GitHubアカウントでサインイン可能）
3. 「New Project」をクリック
4. プロジェクト情報を入力:
   - Name: `kokyou-classroom`（任意）
   - Database Password: 強力なパスワードを生成（メモ必須！）
   - Region: `Northeast Asia (Tokyo)`
   - Pricing Plan: Free（開始時は無料プランで十分）
5. 「Create new project」をクリック（数分かかります）

### ステップ3: データベースのセットアップ

プロジェクトが作成されたら、以下のSQLファイルを順番に実行します。

**実行手順:**
1. Supabaseダッシュボードで左側メニューから「SQL Editor」をクリック
2. 「New query」をクリック
3. 以下のSQLファイルの内容を1つずつコピー＆ペーストして「Run」を押す

**実行順序:**

1. **基本スキーマ** (`supabase-schema.sql`):
   - students（生徒）
   - teachers（教員）
   - sessions（授業セッション）
   - topic_posts（トピック投稿）
   - interactions（コメント）
   - notes（学習メモ）

2. **掲示板スキーマ** (`supabase-board-schema.sql`):
   - boards（掲示板）
   - submissions（作品提出）
   - peer_reviews（ピアレビュー）
   - reviewer_profiles（匿名プロフィール）

3. **返信機能** (`supabase-board-add-reply.sql`):
   - peer_reviewsテーブルに返信フィールドを追加

4. **通知システム** (`supabase-notifications.sql`):
   - notifications（通知）

**重要**: 各SQLファイルは、GitHubリポジトリのルートディレクトリにあります。フォークしたリポジトリで内容を確認できます。

### ステップ4: Supabase接続情報の取得

1. Supabaseダッシュボードで「Settings」→「API」をクリック
2. 以下の情報をメモ:
   - **Project URL**: `https://xxxxx.supabase.co`
   - **anon/public key**: `eyJhbGci...`（長い文字列）

### ステップ5: Vercelでデプロイ

1. https://vercel.com/ にアクセス
2. GitHubアカウントでサインイン
3. 「Add New...」→「Project」をクリック
4. フォークしたリポジトリ（`kokyou-no-kyoushitsu-v4`）を選択
5. 「Import」をクリック
6. 環境変数を設定:
   - `NEXT_PUBLIC_SUPABASE_URL`: （ステップ4のProject URL）
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`: （ステップ4のanon key）
7. 「Deploy」をクリック
8. 数分待つとデプロイ完了！URLが表示されます（例: `https://your-project.vercel.app`）

### ステップ6: 初期データの投入（オプション）

デモ用の教員・生徒アカウントを作成する場合:

1. Supabase SQL Editorで以下を実行:

```sql
-- デモ教員アカウント
INSERT INTO teachers (email, hashed_password, name)
VALUES ('teacher@yourschool.ed.jp', crypt('yourpassword', gen_salt('bf')), '先生の名前');

-- デモ生徒アカウント（例）
INSERT INTO students (google_email, display_name, student_number, class_id)
VALUES
  ('student1@yourschool.ed.jp', '生徒1', 1, '1年A組'),
  ('student2@yourschool.ed.jp', '生徒2', 2, '1年A組');
```

### ステップ7: Google OAuth の設定（推奨・本番運用時）

デモ版ではlocalStorage認証ですが、本番運用では学校のGoogleアカウントと連携することを推奨します。

**Google OAuth設定手順:**

1. **Google Cloud Consoleでプロジェクト作成**
   - https://console.cloud.google.com/ にアクセス
   - 新しいプロジェクトを作成（例: `kokyou-classroom`）

2. **OAuth同意画面の設定**
   - 「APIとサービス」→「OAuth同意画面」
   - User Type: 内部（学校ドメインのユーザーのみ）
   - アプリ名: `公共の教室`
   - サポートメール: あなたのメールアドレス
   - 承認済みドメイン: あなたの学校ドメイン（例: `yourschool.ed.jp`）

3. **OAuth 2.0 クライアントIDの作成**
   - 「APIとサービス」→「認証情報」
   - 「認証情報を作成」→「OAuth クライアント ID」
   - アプリケーションの種類: ウェブアプリケーション
   - 承認済みのリダイレクトURI:
     - `https://your-project.vercel.app/api/auth/callback/google`
     - `http://localhost:3000/api/auth/callback/google`（開発用）
   - クライアントIDとクライアントシークレットをメモ

4. **Vercelに環境変数を追加**
   - Vercelダッシュボードで「Settings」→「Environment Variables」
   - 以下を追加:
     - `GOOGLE_CLIENT_ID`: （手順3のクライアントID）
     - `GOOGLE_CLIENT_SECRET`: （手順3のクライアントシークレット）
     - `NEXTAUTH_URL`: `https://your-project.vercel.app`
     - `NEXTAUTH_SECRET`: ランダムな文字列（`openssl rand -base64 32` で生成）

5. **コードの修正**（AIアシスタントに依頼）
   - NextAuth.jsの設定ファイルを作成
   - 認証フローをlocalStorageからNextAuthに移行
   - 学校ドメインのメールアドレスのみ許可するバリデーション追加

**AIサポート用プロンプト例:**
```
公共の教室v4のGoogle OAuth設定を手伝ってください。
現在はlocalStorage認証ですが、NextAuth.jsを使って学校のGoogleアカウント（@yourschool.ed.jp）のみでログインできるようにしたいです。

必要な設定:
- Google OAuth Client ID: [あなたのID]
- Google OAuth Client Secret: [あなたのシークレット]
- 許可ドメイン: yourschool.ed.jp

どのファイルを作成・修正すればよいか、ステップバイステップで教えてください。
```

### ステップ8: 動作確認

1. デプロイされたURLにアクセス
2. 教員ページ（`/teacher`）でログインテスト
3. 生徒ページ（`/student`）でログインテスト
4. セッション作成・参加のテスト
5. 掲示板作成・提出・レビューのテスト
6. 通知機能のテスト

---

## AIサポートの活用方法

このドキュメント全体をAIアシスタント（ChatGPT、Claude等）に貼り付けることで、以下のサポートを受けられます:

### 1. 導入時のサポート

**プロンプト例:**
```
以下のドキュメントの「自分の学校への導入手順」を実行中です。
現在[ステップ番号]まで完了しました。

[直面している問題や質問]

次に何をすればよいか、詳しく教えてください。
```

### 2. エラー解決のサポート

**プロンプト例:**
```
公共の教室v4を導入中に以下のエラーが発生しました:

エラーメッセージ: [エラー内容]
実行していた操作: [何をしていたか]
使用しているブラウザ/OS: [環境情報]

解決方法を教えてください。
```

### 3. カスタマイズのサポート

**プロンプト例:**
```
公共の教室v4をカスタマイズしたいです。

希望する変更:
- [変更内容1]
- [変更内容2]

どのファイルをどのように修正すればよいか、コード例とともに教えてください。
```

### 4. Google OAuth設定のサポート

**プロンプト例:**
```
公共の教室v4にGoogle OAuth認証を追加したいです。

現在の状態:
- Google Cloud ConsoleでクライアントIDを取得済み
- Vercelに環境変数を設定済み

NextAuth.jsの設定方法を、ファイル名とコード例を含めて詳しく教えてください。
学校ドメイン（@yourschool.ed.jp）のアカウントのみ許可する実装もお願いします。
```

### 5. データベース設計の理解

**プロンプト例:**
```
公共の教室v4のデータベース構造について教えてください。

特に知りたいこと:
- [テーブル名]の役割
- [テーブル1]と[テーブル2]のリレーション
- [機能名]のデータフロー

ER図風の説明があると助かります。
```

---

## トラブルシューティング

### よくある問題と解決方法

#### 1. デプロイ後に画面が表示されない

**原因**: 環境変数の設定ミス

**解決方法**:
1. Vercelダッシュボード → Settings → Environment Variables を確認
2. `NEXT_PUBLIC_SUPABASE_URL` と `NEXT_PUBLIC_SUPABASE_ANON_KEY` が正しく設定されているか確認
3. 変更後は「Deployments」タブから「Redeploy」を実行

#### 2. ログインできない

**原因**: データベースにユーザーデータが存在しない

**解決方法**:
1. Supabase SQL Editorで以下を実行して確認:
```sql
SELECT * FROM teachers LIMIT 5;
SELECT * FROM students LIMIT 5;
```
2. データが空の場合、ステップ6の初期データ投入を実行

#### 3. セッションに参加できない

**原因**: セッションコードが存在しない、または期限切れ

**解決方法**:
1. 教員画面でアクティブなセッションを確認
2. 新しいセッションを作成してコードを再取得
3. 生徒画面で正確に4桁コードを入力（大文字小文字は自動変換されます）

#### 4. 掲示板が表示されない

**原因**: 掲示板テーブルが作成されていない

**解決方法**:
1. Supabase SQL Editorで `supabase-board-schema.sql` を再実行
2. 以下で確認:
```sql
SELECT * FROM boards LIMIT 5;
```

#### 5. 通知が表示されない

**原因**: notificationsテーブルが存在しない

**解決方法**:
1. `supabase-notifications.sql` を実行
2. ブラウザのキャッシュをクリア（Ctrl+Shift+R or Cmd+Shift+R）
3. 再ログイン

#### 6. レビューが投稿できない

**原因**: reviewer_profilesの動物アイコン割り当てに失敗

**解決方法**:
1. Supabase SQL Editorで確認:
```sql
SELECT * FROM reviewer_profiles WHERE student_id = [あなたの生徒ID];
```
2. データがない場合、初回レビュー投稿時に自動生成されるはずなので、ブラウザコンソール（F12）でエラーを確認
3. エラー内容をAIアシスタントに共有

---

## システムアーキテクチャ詳細（開発者向け）

### ディレクトリ構造

```
kokyou-no-kyoushitsu-v4/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/                # APIエンドポイント
│   │   │   ├── auth/           # 認証API
│   │   │   ├── board/          # 掲示板API
│   │   │   ├── interactions/   # コメントAPI
│   │   │   └── ...
│   │   ├── board/              # 掲示板UI
│   │   ├── classroom/          # 教室UI
│   │   ├── student/            # 生徒用ページ
│   │   ├── teacher/            # 教員用ページ
│   │   └── ...
│   ├── components/             # 再利用可能コンポーネント
│   │   ├── board/              # 掲示板コンポーネント
│   │   └── NotificationDropdown.tsx
│   ├── lib/                    # ユーティリティ
│   │   ├── board/              # 掲示板ロジック
│   │   ├── notifications.ts    # 通知ロジック
│   │   ├── supabase.ts         # Supabaseクライアント
│   │   └── storage.ts          # localStorageラッパー
│   └── types/                  # TypeScript型定義
├── supabase-*.sql              # データベーススキーマ
└── ...
```

### データフロー

#### 1. 授業セッション参加フロー

```
生徒がコード入力
  ↓
POST /api/auth (sessionCode + studentEmail)
  ↓
Supabaseでsessions テーブル検索
  ↓
students テーブルで生徒確認
  ↓
セッション情報をlocalStorageに保存
  ↓
/classroom/[code] にリダイレクト
```

#### 2. ピアレビュー投稿フロー

```
レビューフォーム送信
  ↓
POST /api/board/review
  ↓
reviewer_profiles で動物アイコン取得/生成
  ↓
peer_reviews にレビュー保存
  ↓
createNotification() で投稿者に通知
  ↓
レビュー一覧を再取得して表示
```

#### 3. 通知確認フロー

```
生徒メニュー表示
  ↓
getUnreadCount(studentId) 実行
  ↓
通知バッジに未読数表示
  ↓
通知ボタンクリック
  ↓
NotificationDropdown表示
  ↓
getAllNotifications() で通知一覧取得
  ↓
通知クリックで該当ページに遷移 + markAsRead()
```

### セキュリティ考慮事項

1. **Row Level Security (RLS)**: Supabaseで有効化推奨（現在はサーバー側で制御）
2. **CORS設定**: Vercelドメインのみ許可
3. **環境変数**: `.env.local` に保存、Gitにコミットしない
4. **パスワードハッシュ化**: bcrypt使用（teachers テーブル）
5. **Google OAuth**: 学校ドメインのみ許可する実装推奨

---

## FAQ

### Q1: 無料で使えますか？
**A**: はい。Supabase（Free plan: 500MB DB、5GB転送/月）とVercel（Hobby plan: 無料）で小規模〜中規模の学校なら十分運用可能です。

### Q2: 生徒数の上限は？
**A**: Supabaseの無料プランでは同時接続数に制限がありますが、数百人規模なら問題ありません。1000人を超える場合はPro plan（$25/月）を検討してください。

### Q3: データのバックアップは？
**A**: Supabaseダッシュボードから定期的にバックアップを取得できます（Database → Backups）。CSV/JSONエクスポート機能も活用してください。

### Q4: スマホで使えますか？
**A**: はい。レスポンシブデザインで、スマホ・タブレットでも利用可能です。

### Q5: オフラインで使えますか？
**A**: いいえ。インターネット接続が必要です。

### Q6: 他の学校と共有できますか？
**A**: このデモ版は共有可能ですが、本番運用では学校ごとに独自のSupabase + Vercelプロジェクトを作成することを推奨します。

### Q7: カスタマイズは自由ですか？
**A**: はい。MITライセンス（予定）で公開しているため、自由に改変・再配布可能です。

### Q8: 技術サポートはありますか？
**A**: 公式サポートはありませんが、GitHubのIssuesで質問できます。また、このドキュメントをAIアシスタントに貼り付けてサポートを受けることを推奨します。

---

## 更新履歴

- **v4.5** (2025-01-XX): 掲示板システム・統合通知システム・返信機能を追加
- **v4.0** (2024-XX-XX): 教室システム・ポートフォリオ機能を実装
- **v3.0** (2023-XX-XX): 初版リリース

---

## ライセンス

MIT License (予定)

---

## 作者・貢献

- 開発: boomboom0911
- AI開発支援: Claude (Anthropic)

**貢献歓迎！** プルリクエストやIssueをお待ちしています。
GitHub: https://github.com/boomboom0911/kokyou-no-kyoushitsu-v4

---

## AIアシスタントへの指示（このドキュメントを渡す場合）

このドキュメントを受け取ったAIアシスタント（ChatGPT/Claude等）へ:

このドキュメントは「公共の教室 v4」という教育用Webアプリケーションの完全ガイドです。ユーザーは以下のいずれかを求めています:

1. **デモ版の使い方を知りたい** → 「デモ版の利用方法」セクションを参照して説明
2. **自分の学校に導入したい** → 「自分の学校への導入手順」を順番にサポート
3. **エラーが発生した** → 「トラブルシューティング」を参照し、該当しない場合は詳細をヒアリング
4. **カスタマイズしたい** → 「システムアーキテクチャ詳細」を参照してコード例を提示
5. **Google OAuth設定** → ステップ7の手順を詳しく解説、NextAuth.js設定コード例を提供

**サポート時の心構え:**
- ユーザーは技術初心者の可能性が高い
- 専門用語は避け、スクリーンショット付きで説明
- コマンドやコードは必ずコードブロックで提示
- エラーが出た場合は、エラーメッセージ全文の共有を依頼
- 1ステップずつ確認しながら進める

ユーザーの質問や状況を確認し、適切なセクションを参照しながらサポートしてください。
